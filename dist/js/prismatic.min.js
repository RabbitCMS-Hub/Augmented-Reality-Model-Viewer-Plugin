/*
 @license
 Copyright (c) 2018 Magic Leap, Inc. All Rights Reserved.
 You may use this file to develop and test websites that are compatible with
 Magic Leap?s mixed reality technology platform (including Magic Leap?s mixed
 reality hardware device(s) manufactured by or on behalf of Magic Leap and
 Magic Leap?s operating systems), and distribute this file as incorporated
 into those websites.  You may not modify this file, or use this file to
 directly or indirectly develop websites that are incompatible Magic Leap?s
 mixed reality technology platform.

 TO THE MAXIMUM EXTENT PERMITTED BY APPLICABLE LAW, MAGIC LEAP IS PROVIDING
 THIS FILE ON AN ?AS-IS? BASIS FOR USE AT YOUR OWN RISK. MAGIC LEAP DISCLAIMS
 ALL WARRANTIES WITH RESPECT TO THIS FILE, WHETHER EXPRESS OR IMPLIED, OR
 STATUTORY, INCLUDING, WITHOUT LIMITATION, ANY WARRANTIES OF NON-INFRINGEMENT
 OF THIRD-PARTY RIGHTS, MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE,
 QUIET ENJOYMENT, NON-INTERFERENCE, SYSTEM INTEGRATION, OR ACCURACY.
 MAGIC LEAP DOES NOT WARRANT THAT YOUR USE OF THIS FILE WILL BE UNINTERRUPTED
 ERROR-FREE, VIRUS-FREE, OR SECURE.
*/
'use strict';(function(k,m){"object"===typeof exports&&"undefined"!==typeof module?m(exports):"function"===typeof define&&define.amd?define(["exports"],m):m(k.prismatic={})})(this,function(k){function m(){n(this,!0)}function oa(){p(this)}let z=()=>{window.mlWorld.update();setTimeout(z,16)},g=(a)=>{let b=window.mlWorld.browserWidth-.1,c=window.innerWidth;a=parseFloat(a)/c;return Math.fround(a*b)},h=(a)=>({width:g(a.clientWidth),height:g(a.clientHeight),breadth:isNaN(a.breadth)?g(a.clientWidth):g(a.breadth)}),
A=(a)=>{var b=a.getBoundingClientRect();let c=J(b.left+a.clientWidth/2);b=K(b.top+a.clientHeight/2);a=L(a.zOffset);return{positionX:c,positionY:b,positionZ:a}},J=(a)=>{a=g(a)+.05-window.mlWorld.browserWidth/2;return Math.fround(a)},K=(a)=>{a=window.mlWorld.browserHeight/2-(g(a)+.096);return Math.fround(a)},L=(a)=>{a=g(a);return Math.fround(a)},B=(a)=>{let {positionX:b,positionY:c,positionZ:d}=A(a),{width:e,height:f,breadth:r}=h(a);return Math.abs(b)>mlWorld.browserWidth/2||Math.abs(c)>mlWorld.browserHeight/
2||Math.abs(d)>Math.max(mlWorld.browserWidth,mlWorld.browserHeight)/2||e>mlWorld.browserWidth||f>mlWorld.browserHeight||r>Math.max(mlWorld.browserWidth,mlWorld.browserHeight)?!0:!1},C=(a,b)=>{console.warn(b);a.style.border="solid 2px #ffffff47";a.style.color="#FFF";a.style.color="#FFF";a.style.textTransform="uppercase";a.style.letterSpacing="2px";a.style.fontSize="14px";a.style.padding="2%";a.innerHTML="MR Content"},pa=(a)=>{var b={};a.split(/;/).forEach((a)=>{a=a.split(":");2===a.length&&("textures"===
a[0].trim()?b[a[0].trim()]=a[1].trim().replace(/\r?\n|\r|\t|,/gm," ").replace(/  +/g," ").split(/ /).filter((a)=>a.trim()):b[a[0].trim()]=a[1].trim())});if(b.kmat&&b.textures&&0<b.textures.length)return b;console.error("Invalid values used for materials attribute. No materials loaded.")},qa=(a,b)=>Promise.all(b.map(function(b){return new Promise((c,e)=>{var d=new Image;d.onload=()=>{c(a.createTexture(d,b))};d.onerror=()=>{e(Error(`Problem loading texture ${b}.`))};d.src=b})})),ra=(a,b)=>fetch(b).then((c)=>
c.ok?c.arrayBuffer().then((c)=>a.createKMat(c,b)):Promise.reject(Error(`Problem creating KMat file: ${b}`))),D=(a)=>{if((a=a.trim().replace(/[^\d.-]+/g," ").split(" ").map(parseFloat).filter((a)=>!isNaN(a)))&&3===a.length)return a;console.error("Invalid values used for rotation attribute.")},n=(a,b=!1)=>{if(a._volume){let {positionX:c,positionY:d,positionZ:e}=A(a);a._volume.position={positionX:c,positionY:d,positionZ:e};let f=(new DOMMatrix).translate(c,d,e);a.prismRotation&&b&&(b=D(a.prismRotation))&&
(f=f.rotateAxisAngle(0,0,1,180/Math.PI*b[2]).rotateAxisAngle(0,1,0,180/Math.PI*b[1]).rotateAxisAngle(1,0,0,180/Math.PI*b[0]));a._volume.transformVolumeRelativeToHostVolume(f)}},M=(a)=>{if(a._model){let {width:c,height:d,breadth:e}=h(a);if(!a.hasAttribute("fill")||""!==a.getAttribute("fill")&&"true"!==a.getAttribute("fill")){if(a.breadth)b=Math.min(c/a._resource.width,d/a._resource.height,e/a._resource.depth);else{var b=Math.min(c/a._resource.width,d/a._resource.height);a._volume.setSize(1.001*c,1.001*
d,a._resource.depth*b*1.001)}a._model.setLocalScale(new Float32Array([b,b,b]))}else a._model.setLocalScale(new Float32Array([c/a._resource.width,d/a._resource.height,e/a._resource.depth]))}a._model.setAnchorPosition(new Float32Array([a._resource.center.x,a._resource.center.y,a._resource.center.z]))},N=(a)=>{if(a._quad){let {width:b,height:c}=h(a);a._quad.setLocalScale(new Float32Array([b,c,0]));a._quad.setLocalPosition(new Float32Array([-(b/2),-(c/2),0]))}},p=(a)=>{if(a._model||a._quad)B(a)?navigator.permissions.request({name:"ml-unbounded-prisms"}).then((b)=>
{"granted"==b.state?O(a):"denied"==b.state&&console.error("Permission to render unbounded volume has not been granted")}).catch((b)=>{C(a,"Requesting ml-unbounded-prisms is not supported on this device")}):O(a)},O=(a)=>{if(a._model||a._quad){if(a._volume){let {width:b,height:c,breadth:d}=h(a);0===b||0===c||0===d?console.error(`At least one of the dimension was not specified. Dimensions are specified using CSS width/height properties. ${a.id}`):a._volume.setSize(1.001*b,1.001*c,1.001*d)}n(a,!0);a._model?
M(a):a._quad&&N(a)}},E=(a)=>{void 0===a._mutationObserver&&(a._mutationObserver=new MutationObserver((b)=>{b.forEach((b)=>{var c;if(c=a._volume){c=b.target;var {width:e,height:f}=h(c);c=Math.fround(e)!==Math.fround(c._volume.width/1.001)||Math.fround(f)!==Math.fround(c._volume.height/1.001)?!0:!1;if(!c){c=b.target;var {positionX:r,positionY:g}=A(c);c=Math.fround(r)!==Math.fround(c._volume.position.positionX)||Math.fround(g)!==Math.fround(c._volume.position.positionY)?!0:!1}}c&&p(b.target)})}),a._mutationObserver.observe(a,
{attributeOldValue:!0,attributes:!0,attributeFilter:["style","class"]}))},F=(a)=>{void 0===a._resizeObserver&&(a._resizeObserver=new ResizeObserver((b)=>{b.forEach((b)=>{var c;if(c=a._model||a._quad){c=b.target;var {width:e,height:f}=h(c);c=Math.fround(e)!==Math.fround(c._volume.width/1.001)||Math.fround(f)!==Math.fround(c._volume.height/1.001)?!0:!1}c&&p(b.target)})}),a._resizeObserver.observe(a))},sa=(a)=>{if(0===a.clientWidth||0===a.clientHeight)a._mutationObserver&&(a._mutationObserver.disconnect(),
delete a._mutationObserver),a._resizeObserver&&(a._resizeObserver.disconnect(),delete a._resizeObserver),0===a.clientWidth&&(a.style.width=0<a.clientHeight?`${a.clientHeight}px`:"inherit",0===a.clientWidth&&(a.style.width="auto"),0===a.clientWidth&&(a.style.width=`${a.parentElement.clientWidth}px`)),0===a.clientHeight&&(a.style.height="inherit",0===a.clientHeight&&(a.style.height="auto"),0===a.clientHeight&&0<a.clientWidth&&(a.style.height=`${a.clientWidth}px`)),E(a),F(a)},P=(a)=>{if(a._volume)throw Error("Volume already exists");
0!==a.clientWidth&&0!==a.clientHeight||sa(a);let {width:b,height:c,breadth:d}=h(a);if(0===b||0===c||0===d)throw Error("At least one of the volume's dimension is not specified.  Dimensions are specified using CSS width/height properties");let e=window.mlWorld.createVolume(1.001*b,1.001*c,1.001*d);if(!e)throw Error("Volume was not created");e.addEventListener("mlraycast",(b)=>{if("volume"===b.hitData.type)b=new CustomEvent("volume-raycast",{detail:{type:b.type,hitData:b.hitData}}),a.dispatchEvent(b);
else if("quadNode"===b.hitData.type||"modelNode"===b.hitData.type)b=new CustomEvent("node-raycast",{detail:{type:b.type,hitData:b.hitData}}),a.dispatchEvent(b)});return e},ta=(a,b)=>(new RegExp(/\.(fbx|glb)(\?|#|$)/i)).test(b)?fetch(b).then((c)=>c.ok?c.arrayBuffer().then((c)=>{let d=a._volume,f;if(b.match(/\.glb(\?|#|$)/i)&&"glTF"===String.fromCharCode.apply(null,new Uint8Array(c,0,4)))f="Pbr";else if(b.match(/\.fbx(\?|#|$)/i)&&"Kaydara FBX Binary  \x00\u001a\x00"===String.fromCharCode.apply(null,
new Uint8Array(c,0,23)))f="UnlitTextured";else return Promise.reject(Error(`Invalid model file: ${b}. Only FBX and GLB are supported at the moment.`));return(c=d.createModelResource(c))?{resource:c,shader:f}:Promise.reject(Error(`Load resource failed: ${b}`))}):Promise.reject(Error(`Load resource failed: ${b}`))):Promise.reject(Error(`Invalid model file extension: ${b}. Only FBX and GLB are supported at the moment.`)),ua=(a)=>{var b={};a.split(/;/).forEach((a)=>{a=a.split(":");2===a.length&&(b[a[0].trim()]=
a[1].trim())});if(b["color-intensity"]||b["bloom-strength"])return b;console.error("Invalid values used for environment lighting attribute. Make sure to specify color-intensity or bloom-strength.")},q=(a)=>{a._volume&&(window.mlWorld.deleteVolume(a._volume),a._volume=void 0,a._model=void 0,a._quad=void 0,a._transform=void 0,a._resource=void 0)},t=(a,b=!0)=>{a.skipRaycast=b},Q=(a,b=!1)=>{a._volume&&(a._volume.visible=b)},R=(a,b)=>{document.getElementById(b)&&document.getElementById(b).addEventListener("click",
()=>{document.querySelectorAll("ml-model[trigger], ml-quad[trigger]").forEach(function(a){a.visibility="hidden"});a.visibility="show"})},S=(a,b)=>{b&&a._transform&&(b=b.trim().replace(/[^\d.-]+/g," ").split(" ").map(parseFloat).filter((a)=>!isNaN(a)),a._transform.setLocalScale(new Float32Array(b)),a.isInsideVolume()||console.warn(`Content is clipping or is rendering outside of prism. ${a.id}`))},T=(a,b)=>{b&&(b=b.trim().replace(/  +/g," ").split(" ").map(g),a._transform.setLocalPosition(new Float32Array(b)),
a.isInsideVolume()||console.warn(`Content is clipping or is rendering outside of prism. ${a.id}`))},U=(a,b)=>{if(b){var c=D(b);b=Math.cos(c[0]/2);var d=Math.cos(c[1]/2),e=Math.cos(c[2]/2),f=Math.sin(c[0]/2),r=Math.sin(c[1]/2);c=Math.sin(c[2]/2);(b=[f*d*e-b*r*c,b*r*e+f*d*c,b*d*c-f*r*e,b*d*e+f*r*c],a._transform)&&a._transform.setLocalRotation(new Float32Array(b))}},V=(a,b)=>{if(b&&(b=D(b))){let c=(new DOMMatrix).translate(a._volume.position.positionX,a._volume.position.positionY,a._volume.position.positionZ);
c=c.rotateAxisAngle(0,0,1,180/Math.PI*b[2]).rotateAxisAngle(0,1,0,180/Math.PI*b[1]).rotateAxisAngle(1,0,0,180/Math.PI*b[0]);a._volume.transformVolumeRelativeToHostVolume(c)}},va=(a)=>{var b={},c=["name","paused","iterations"];a.split(/;|,/).forEach((a,e)=>{a=a.split(":");2===a.length?b[a[0].trim()]=a[1].trim():1===a.length&&(b[c[e]]=a[0].trim())});if(b.name)return b.paused?b.paused="false"===b.paused||"no"===b.paused||"0"===b.paused||""===b.paused?!1:!0:(b.paused=!1,console.warn("Invalid paused value for animation attribute. Default value of false used.")),
isNaN(parseInt(b.iterations))?(b.iterations=-1,console.warn("Invalid iterations value for model-animation attribute. Default value of -1 used.")):b.iterations=parseInt(b.iterations),b;console.error("No animation name found in animation attribute.")},wa=(a,b,c)=>{b&&(b=va(b))&&a._model&&(a._model.playAnimation(b.name,b.paused,b.iterations),c&&(a._model.animationPlaybackSpeed=Number(c)),a._volume.addEventListener("mlanimation",(b)=>{"animationEnd"===b.type&&(b=new CustomEvent("model-animation-end",
{detail:{animationName:b.animationName}}),a.dispatchEvent(b))}))},l=(a,b=!1)=>{var c={};a.split(/;/).forEach((a)=>{a=a.split(":");2===a.length&&("offset"===a[0].trim()?c[a[0].trim()]=a[1].trim().replace(/\r?\n|\r|\t|,/gm," ").replace(/  +/g," ").split(" "):(c[a[0].trim()]=a[1].match(/[+-]?\d+(\.\d+)?/g).map((a)=>parseFloat(a)),1===c[a[0].trim()].length&&(c[a[0].trim()]=c[a[0].trim()][0])))});if(c.axes&&3===c.axes.length||c.angles&&3===c.angles.length||c.offset&&3===c.offset.length)return isNaN(c.duration)&&
(c.duration=1,console.warn("No duration value in animation attribute. Default value of 1 used.")),Number.isInteger(c.track)||(c.track=0,console.warn("No track value in animation attribute. Default value of 0 used.")),b&&isNaN(c.angle)&&(c.angle=360,console.warn("No angle value in spin animation attribute. Default value of 360 degrees used.")),c;console.error("Invalid axis values used for animation attribute.")},W=(a,b)=>{if(b){let c=l(b,!0);c&&(a._transform.spin(new Float32Array(c.axes),Math.PI/180*
c.angle,c.duration,c.track),a._transform.addMoveCallback(c.track),a._volume.addEventListener("mltransformanimation",function(b){b.track===c.track&&(b.stopImmediatePropagation(),b=new CustomEvent("transform-animation-end",{detail:{track:b.track,type:b.type}}),a.dispatchEvent(b))}))}},X=(a,b)=>{if(b){let c=l(b);c&&(a._transform.scaleTo(new Float32Array(c.axes),c.duration,c.track),a._transform.addMoveCallback(c.track),a._volume.addEventListener("mltransformanimation",function(b){b.track===c.track&&(b.stopImmediatePropagation(),
b=new CustomEvent("transform-animation-end",{detail:{track:b.track,type:b.type}}),a.dispatchEvent(b))}),a.isInsideVolume(a._transform.getLocalPosition(),c.axes)||console.warn(`Content is clipping or is rendering outside of prism. ${a.id}`))}},xa=(a,b)=>{switch(b[0]){case "left":var c=0;break;case "middle":case "center":c=window.outerWidth/2;break;case "right":c=window.outerWidth;break;default:c=isNaN(parseFloat(b[0]))?void 0:parseFloat(b[0])}switch(b[1]){case "top":var d=0;break;case "middle":case "center":d=
window.outerHeight/2;break;case "bottom":d=window.outerHeight;break;default:d=isNaN(parseFloat(b[1]))?void 0:parseFloat(b[1])}b=isNaN(parseFloat(b[2]))?void 0:parseFloat(b[2]);b=[c,d,b];c=isNaN(parseFloat(b[0]))?a._transform.getLocalPosition()[0]:J(b[0])-a._volume.position.positionX;d=isNaN(parseFloat(b[1]))?a._transform.getLocalPosition()[1]:K(b[1])-a._volume.position.positionY;a=isNaN(parseFloat(b[2]))?a._transform.getLocalPosition()[2]:L(b[2])-a._volume.position.positionZ;return[c,d,a]},Y=(a,b)=>
{if(b){let d=l(b);if(d){var c;d.offset?c=xa(a,d.offset):d.axes&&(c=d.axes.map(g));a._transform.moveTo(new Float32Array(c),d.duration,d.track);a._transform.addMoveCallback(d.track);a._volume.addEventListener("mltransformanimation",function(b){b.track===d.track&&(b.stopImmediatePropagation(),b=new CustomEvent("transform-animation-end",{detail:{track:b.track,type:b.type}}),a.dispatchEvent(b))});a.isInsideVolume(c)||console.warn(`Content is clipping or is rendering outside of prism. ${a.id}`)}}},Z=(a,
b)=>{if(b){let c=l(b);if(c&&c.axes){b=c.axes.map(g);let d=a._transform.getLocalPosition(),e=b.map((a,b)=>a+d[b]);a._transform.moveBy(new Float32Array(b),c.duration,c.track);a._transform.addMoveCallback(c.track);a._volume.addEventListener("mltransformanimation",function(b){b.track===c.track&&(b.stopImmediatePropagation(),b=new CustomEvent("transform-animation-end",{detail:{track:b.track,type:b.type}}),a.dispatchEvent(b))});a.isInsideVolume(e)||console.warn(`Content is clipping or is rendering outside of prism. ${a.id}`)}else console.error(`Invalid axis values used for animation attribute. ${a.id}`)}},
aa=(a,b)=>{if(b){let c=l(b);c&&(a._transform.rotateToAngles(new Float32Array(c.angles),c.duration,c.track),a._transform.addMoveCallback(c.track),a._volume.addEventListener("mltransformanimation",function(b){b.track===c.track&&(b.stopImmediatePropagation(),b=new CustomEvent("transform-animation-end",{detail:{track:b.track,type:b.type}}),a.dispatchEvent(b))}))}},ba=(a,b)=>{if(b){let c=l(b);c&&(a._transform.rotateByAngles(new Float32Array(c.angles),c.duration,c.track),a._transform.addMoveCallback(c.track),
a._volume.addEventListener("mltransformanimation",function(b){b.track===c.track&&(b.stopImmediatePropagation(),b=new CustomEvent("transform-animation-end",{detail:{track:b.track,type:b.type}}),a.dispatchEvent(b))}))}},u=(a)=>{a&&a.addEventListener("mousedown",G,!1)},G=(a)=>{if(6===a.button&&(a.preventDefault(),a=a.target,a._volume&&(a._model||a._quad))){a._originalScale&&a._transform.setLocalScale(new Float32Array([a._originalScale[0],a._originalScale[1],a._originalScale[2]]));a._originalPosition&&
a._transform.setLocalPosition(new Float32Array([a._originalPosition[0],a._originalPosition[1],a._originalPosition[2]]));window.mlWorld.update();a._volume.setSize(a._originalVolumeSize[0],a._originalVolumeSize[1],a._originalVolumeSize[2]);var b=new Event("extracting-node");a.dispatchEvent(b);{var c=a._volume.position;b=a.extractedScale?a.extractedScale:1;let d=c.positionZ+a._volume.breadth;c=(new DOMMatrix).translate(c.positionX,c.positionY,d);a._volume.extractContent({scale:b,transform:c,doIt:"auto",
origin_url:a.extractedLink?a.extractedLink:window.location.href});b=new Event("node-extracted");a.dispatchEvent(b)}b=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});a.dispatchEvent(b)}},v=(a)=>{a.style.cursor="-webkit-grab";a.addEventListener("mouseover",ca);a.addEventListener("mouseout",da);a.addEventListener("mousemove",H)},ea=(a)=>{a.style.cursor="auto";a.removeEventListener("mouseover",ca);a.removeEventListener("mouseout",da);a.removeEventListener("mousemove",H)},ca=(a)=>{a=
a.target;a._volume&&a._transform&&(a.removeEventListener("mousemove",H),a._volume.triggerTotemHaptic("VIBE_TICK"),a._mouseOutTimeout&&(clearTimeout(a._mouseOutTimeout),a._mouseOutTimeout=null),a._originalVolumeSize||(a._originalVolumeSize=[a._volume.width,a._volume.height,a._volume.breadth]),a._volume.setSize(1.25*a._originalVolumeSize[0],1.25*a._originalVolumeSize[1],1.25*a._originalVolumeSize[2]+.04),a._originalScale||(a._originalScale=a._transform.getLocalScale()),a._transform.scaleTo(new Float32Array([1.25*
a._originalScale[0],1.25*a._originalScale[1],1.25*a._originalScale[2]]),.1,-1),a._originalPosition||(a._originalPosition=a._transform.getLocalPosition()),a._transform.moveBy(new Float32Array([0,0,.02]),.1,-2))},H=(a)=>{a=a.target;let b=document.createEvent("MouseEvent");b.initEvent("mouseover",!0,!0);a.dispatchEvent(b)},da=(a)=>{let b=a.target;b._volume&&b._transform&&(b._volume.triggerTotemHaptic("VIBE_FORCE_DWELL"),b._originalPosition&&b._transform.moveTo(new Float32Array([b._originalPosition[0],
b._originalPosition[1],b._originalPosition[2]]),.1,-1),b._originalScale&&b._transform.scaleTo(new Float32Array([b._originalScale[0],b._originalScale[1],b._originalScale[2]]),.1,-2),b._mouseOutTimeout&&clearTimeout(b._mouseOutTimeout),b._mouseOutTimeout=window.setTimeout(()=>{b._originalVolumeSize&&b._volume&&(window.mlWorld.update(),b._volume.setSize(b._originalVolumeSize[0],b._originalVolumeSize[1],b._originalVolumeSize[2]))},200))},w=(a)=>{void 0===a._scrollListener&&(a._scrollListener=m.bind(a),
window.addEventListener("scroll",a._scrollListener))},x=(a)=>{a._scrollListener&&(window.removeEventListener("scroll",a._scrollListener),delete a._scrollListener)},y=(a)=>{void 0===a._observer&&(a._observer=new IntersectionObserver(ya,{root:null,rootMargin:"0px",threshold:[0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1]}));a._observer.observe(a);a._lastIntersectionRatio=0},ya=(a,b)=>{a.forEach((a)=>{let b=a.target;.5<=a.intersectionRatio&&!b._volume&&b.src?b.doRendering().then(()=>{b._delete?(q(b),b._delete=!1):
(b._rendered=!0,b.scaleScroll&&fa(b,b._lastIntersectionRatio),b._volume.visible="hidden"!==b.visibility)}).catch((a)=>{b.dispatchEvent(new ErrorEvent("error",{error:a,message:a.message||"Problem rendering node",bubbles:!0}));console.error(`Problem rendering: ${a}`)}):.5>a.intersectionRatio&&b._volume&&b.scrollable&&(!0===b._rendered?(q(b),delete b._rendered):b._delete=!0);b.scaleScroll&&fa(b,a.intersectionRatio);b._lastIntersectionRatio=a.intersectionRatio})},fa=(a,b)=>{a.scrollable&&a.scaleScroll&&
a._transform&&(a._originalScale||(a._originalScale=a._transform.getLocalScale()),1>b&&.5<=b?(b=Math.abs(1-b/.5),a._transform.scaleTo(new Float32Array([a._originalScale[0]*b,a._originalScale[1]*b,a._originalScale[2]*b]),0,-1)):.5>=b?a._transform.setLocalScale(new Float32Array([0,0,0])):1===b&&a._transform.scaleTo(new Float32Array([a._originalScale[0],a._originalScale[1],a._originalScale[2]]),0,-1))},ha=(a,b)=>{var c=a._model;b.src&&a._volume&&a.render();b.extractable&&("false"!==b.extractable?(v(a),
u(a)):(ea(a),a&&a.removeEventListener("mousedown",G,!1)));b.scrollable&&("false"!==b.scrollable?(w(a),y(a)):(x(a),a._observer&&(a._observer.unobserve(a),delete a._observer)));if(c){b.color?c.color=b.color:""===b.color&&(c.color="#FFFFFF");if(b["environment-lighting"]){let a=ua(b["environment-lighting"]);a["color-intensity"]&&(c.colorIntensity=a["color-intensity"]);a["bloom-strength"]&&(c.bloomStrength=a["bloom-strength"])}b.raycast&&t(c,"true"!=b.raycast);b.visibility&&Q(a,"hidden"!==b.visibility);
b.trigger&&R(a,b.trigger);b["model-scale"]&&S(a,b["model-scale"]);b["model-position"]&&T(a,b["model-position"]);b.rotation&&U(a,b.rotation);b["prism-rotation"]&&V(a,b["prism-rotation"]);b["model-animation"]&&wa(a,b["model-animation"],a.animationSpeed);b["model-animation-speed"]&&(c=b["model-animation-speed"],!isNaN(parseInt(c))&&a._model&&(a._model.animationPlaybackSpeed=Number(c)));b.spin&&W(a,b.spin);b["scale-to"]&&X(a,b["scale-to"]);b["move-to"]&&Y(a,b["move-to"]);b["move-by"]&&Z(a,b["move-by"]);
b["rotate-to-angles"]&&aa(a,b["rotate-to-angles"]);b["rotate-by-angles"]&&ba(a,b["rotate-by-angles"]);(b.breadth||b["z-offset"])&&p(a)}},I=(a)=>new Promise((b,c)=>{ta(a,a.getAttribute("src")).then((d)=>{a._model||(a._model=a._volume.createModel(),"true"!==a.raycast&&t(a._model));a._resource=d.resource;a._model.setModelResource(a._resource);if(isNaN(parseFloat(a._resource.width))||!isFinite(a._resource.width))return c(Error(`Load resource failed: ${a.src}`));var e=new Event("resource-loaded");a.dispatchEvent(e);
a._kmat||(a._model.shader=d.shader);a._transform||(a._transform=a._volume.createTransform(),a._transform.addChild(a._model),a._volume.addChild(a._transform));a._kmat&&a._textures&&(a._model.textures=a._textures,a._model.kmat=a._kmat);n(a);M(a);d={visibility:a.getAttribute("visibility"),trigger:a.getAttribute("trigger"),color:a.getAttribute("color"),"model-scale":a.getAttribute("model-scale"),"model-position":a.getAttribute("model-position"),rotation:a.getAttribute("rotation"),"rotate-to-angles":a.getAttribute("rotate-to-angles"),
"rotate-by-angles":a.getAttribute("rotate-by-angles"),"model-animation":a.getAttribute("model-animation"),spin:a.getAttribute("spin"),"scale-to":a.getAttribute("scale-to"),"move-to":a.getAttribute("move-to"),"move-by":a.getAttribute("move-by"),"prism-rotation":a.getAttribute("prism-rotation"),"environment-lighting":a.getAttribute("environment-lighting")};ha(a,d);window.mlWorld.update();e=new Event("model-displayed");a.dispatchEvent(e);b(a._model)}).catch((a)=>{c(a)})}),za=(a)=>new Promise((b,c)=>
{if(!a._volume)try{a._volume=P(a)}catch(e){return c(e)}a._volume.visible=!1;if(a.hasAttribute("materials"))var d=pa(a.getAttribute("materials"));if(d)qa(a._volume,d.textures).then((e)=>{a._textures=e;ra(a._volume,d.kmat).then((d)=>{a._kmat=d;d=new Event("mesh-readytoload");a.dispatchEvent(d);a.async?b(a._volume):I(a).then(()=>{b(a._volume)}).catch((a)=>{c(Error(`Problem creating model: ${a}`))})}).catch((a)=>{c(Error(`Problem creating Kmat: ${a}`))})}).catch((a)=>{c(Error(`Problem creating texture: ${a}`))});
else{let d=new Event("mesh-readytoload");a.dispatchEvent(d);a.async?b(a._volume):I(a).then(()=>{b(a._volume)}).catch((a)=>{c(Error(`Problem creating model: ${a}`))})}}),ia=(a)=>{void 0===a._resizeListener&&(a._resizeListener=oa.bind(a),window.addEventListener("resize",a._resizeListener))},ja=(a)=>{a._resizeListener&&(window.removeEventListener("resize",a._resizeListener),delete a._resizeListener)};class ka extends HTMLElement{attachedCallback(){window.mlWorld?(this.style.display="inline-flex",this.scrollable?
(w(this),y(this)):B(this)?navigator.permissions.request({name:"ml-unbounded-prisms"}).then((a)=>{"granted"==a.state?this.render():"denied"==a.state&&console.error("Permission to render unbounded volume has not been granted")}).catch((a)=>{C(this,"Requesting ml-unbounded-prisms is not supported on this device")}):this.render(),this.extractable&&(v(this),u(this)),E(this),F(this),ia(this)):this.dispatchEvent(new ErrorEvent("error",{error:Error("Unable to render 3D content on this device."),message:"No mixed-reality browser detected.",
bubbles:!0}))}createdCallback(){this.addEventListener("error",function(a){!this._model&&this.hasAttribute("alt-img")&&this.setAttribute("style","position: absolute; background-image: url("+this.getAttribute("alt-img")+");  background-repeat: no-repeat; background-size:100%;")},!0)}attributeChangedCallback(a,b,c){this._volume&&ha(this,{[a]:c})}detachedCallback(){q(this);x(this);ja(this)}get async(){return this.hasAttribute("async")&&(""===this.getAttribute("async")||"true"===this.getAttribute("async"))}set async(a){this.setAttribute("async",
a.toString())}get unbounded(){return this.hasAttribute("unbounded")&&(""===this.getAttribute("unbounded")||"true"===this.getAttribute("unbounded"))}set unbounded(a){this.setAttribute("unbounded",a.toString())}get extractable(){return this.hasAttribute("extractable")&&(""===this.getAttribute("extractable")||"true"===this.getAttribute("extractable"))}set extractable(a){this.setAttribute("extractable",a.toString())}get scrollable(){return this.hasAttribute("scrollable")&&(""===this.getAttribute("scrollable")||
"true"===this.getAttribute("scrollable"))}set scrollable(a){this.setAttribute("scrollable",a.toString())}get scaleScroll(){return this.hasAttribute("scale-scroll")&&(""===this.getAttribute("scale-scroll")||"true"===this.getAttribute("scale-scroll"))}set scaleScroll(a){this.setAttribute("scale-scroll",a.toString())}get breadth(){return parseFloat(this.getAttribute("breadth"))}set breadth(a){isNaN(parseFloat(a))||this.setAttribute("breadth",parseFloat(a))}get materials(){return this.getAttribute("materials")}set materials(a){this.setAttribute("materials",
a)}get color(){return this.getAttribute("color")}set color(a){this.setAttribute("color",a)}get visibility(){return this.getAttribute("visibility")}set visibility(a){this.setAttribute("visibility",a)}get raycast(){return this.getAttribute("raycast")}set raycast(a){this.setAttribute("raycast",a.toString())}get rotation(){return this.getAttribute("rotation")}set rotation(a){this.setAttribute("rotation",a)}get rotateToAngles(){return this.getAttribute("rotate-to-angles")}set rotateToAngles(a){this.setAttribute("rotate-to-angles",
a)}get rotateByAngles(){return this.getAttribute("rotate-by-angles")}set rotateByAngles(a){this.setAttribute("rotate-by-angles",a)}get prismRotation(){return this.getAttribute("prism-rotation")}set prismRotation(a){this.setAttribute("prism-rotation",a)}get animation(){return this.getAttribute("model-animation")}set animation(a){this.setAttribute("model-animation",a)}get animationSpeed(){return parseFloat(this.getAttribute("model-animation-speed"))}set animationSpeed(a){isNaN(parseFloat(a))||this.setAttribute("model-animation-speed",
parseFloat(a))}get spin(){return this.getAttribute("spin")}set spin(a){this.setAttribute("spin",a)}get modelPosition(){return this.getAttribute("model-position")}set modelPosition(a){this.setAttribute("model-position",a)}get modelScale(){return this.getAttribute("model-scale")}set modelScale(a){this.setAttribute("model-scale",a)}get scaleTo(){return this.getAttribute("scale-to")}set scaleTo(a){this.setAttribute("scale-to",a)}get extractedScale(){return parseFloat(this.getAttribute("extracted-scale"))}set extractedScale(a){isNaN(parseFloat(a))||
this.setAttribute("extracted-scale",parseFloat(a))}get extractedLink(){return this.getAttribute("extracted-link")}set extractedLink(a){this.setAttribute("extracted-link",a)}get moveTo(){return this.getAttribute("move-to")}set moveTo(a){this.setAttribute("move-to",a)}get moveBy(){return this.getAttribute("move-by")}set moveBy(a){this.setAttribute("move-by",a)}get src(){return this.getAttribute("src")}set src(a){this.setAttribute("src",a)}get zOffset(){return this.hasAttribute("z-offset")&&!isNaN(parseFloat(this.getAttribute("z-offset")))?
parseFloat(this.getAttribute("z-offset")):150}set zOffset(a){isNaN(parseFloat(a))||this.setAttribute("z-offset",parseFloat(a))}get environmentLighting(){return this.getAttribute("environment-lighting")}set environmentLighting(a){this.setAttribute("environment-lighting",a)}render(){this.src&&this.doRendering().then(()=>{this._volume.visible="hidden"!==this.visibility}).catch((a)=>{this.dispatchEvent(new ErrorEvent("error",{error:a,message:a.message||"Problem rendering node",bubbles:!0}));console.error(`Problem rendering: ${a}`)})}doRendering(){return za(this)}createNode(){return I(this)}isInsideVolume(a=
this._transform.getLocalPosition(),b=this._transform.getLocalScale()){let c=Math.fround(this._volume.position.positionX-this._volume.width/2),d=Math.fround(this._volume.position.positionX+this._volume.width/2),e=Math.fround(this._volume.position.positionY-this._volume.height/2),f=Math.fround(this._volume.position.positionY+this._volume.height/2),g=Math.fround(this._volume.position.positionZ-this._volume.breadth/2),k=Math.fround(this._volume.position.positionZ+this._volume.breadth/2),[h,l,m]=a,[n,
p,q]=this._model.getLocalScale(),[t,u,v]=b;a=Math.fround(this._volume.position.positionX+h-Math.fround(this._resource.width*n*t/2));b=Math.fround(this._volume.position.positionX+h+Math.fround(this._resource.width*n*t/2));let w=Math.fround(this._volume.position.positionY+l-Math.fround(this._resource.height*p*u/2)),x=Math.fround(this._volume.position.positionY+l+Math.fround(this._resource.height*p*u/2)),y=Math.fround(this._volume.position.positionZ+m-Math.fround(this._resource.depth*q*v/2)),z=Math.fround(this._volume.position.positionZ+
m+Math.fround(this._resource.depth*q*v/2));return c<=a&&b<=d&&e<=w&&x<=f&&g<=y&&z<=k}}document.registerElement("ml-model",ka);let Aa=(a,b)=>(new RegExp(/(\.(jpg|jpeg|png)(\?|#|$))|^(data:image\/(jpg|jpeg|png);base64,*)/i)).test(b)?new Promise((c,d)=>{var e=new Image;e.onload=()=>{let f=a.createTexture(e);f?c(f):d(Error(`Problem loading quad texture: ${b}.`))};e.onerror=()=>{d(Error(`Problem loading quad texture: ${b}.`))};e.src=b}):Promise.reject(Error(`Invalid quad image file type: ${b}. Only JPG and PNG are supported at the moment for quads.`)),
la=(a,b)=>{let c=a._quad;b.src&&a._volume&&a.render();b.extractable&&("false"!==b.extractable?(v(a),u(a)):(ea(a),a&&a.removeEventListener("mousedown",G,!1)));b.scrollable&&("false"!==b.scrollable?(w(a),y(a)):(x(a),a._observer&&(a._observer.unobserve(a),delete a._observer)));c&&(b.color?c.color=b.color:""===b.color&&((new RegExp(/(\.png(\?|#|$))|^(data:image\/png;base64,*)/i)).test(a.src)?c.color="rgba(255, 255, 255, 0.99)":c.color="#FFFFFF"),b.raycast&&t(c,"true"!=b.raycast),b.visibility&&Q(a,"hidden"!==
b.visibility),b.trigger&&R(a,b.trigger),b["quad-scale"]&&S(a,b["quad-scale"]),b.rotation&&U(a,b.rotation),b["prism-rotation"]&&V(a,b["prism-rotation"]),b.spin&&W(a,b.spin),b["scale-to"]&&X(a,b["scale-to"]),b["quad-position"]&&T(a,b["quad-position"]),b["move-to"]&&Y(a,b["move-to"]),b["move-by"]&&Z(a,b["move-by"]),b["rotate-to-angles"]&&aa(a,b["rotate-to-angles"]),b["rotate-by-angles"]&&ba(a,b["rotate-by-angles"]),(b.breadth||b["z-offset"])&&p(a))},Ba=(a)=>new Promise((b,c)=>{a._quad||(a._quad=a._volume.createQuad(),
"true"!==a.raycast&&t(a._quad),a._quad.backfaceVisibility=!0);a._quad.setRenderResource(a._texture);a._texture&&(a._quad.textures=a._texture);(new RegExp(/(\.png(\?|#|$))|^(data:image\/png;base64,*)/i)).test(a.src)&&(a._quad.color="rgba(255, 255, 255, 0.99)");c=new Event("resource-loaded");a.dispatchEvent(c);a._transform||(a._transform=a._volume.createTransform(),a._transform.addChild(a._quad),a._volume.addChild(a._transform));n(a);N(a);c={visibility:a.getAttribute("visibility"),trigger:a.getAttribute("trigger"),
color:a.getAttribute("color"),"quad-scale":a.getAttribute("quad-scale"),"quad-position":a.getAttribute("quad-position"),rotation:a.getAttribute("rotation"),"rotate-to-angles":a.getAttribute("rotate-to-angles"),"rotate-by-angles":a.getAttribute("rotate-by-angles"),spin:a.getAttribute("spin"),"scale-to":a.getAttribute("scale-to"),"move-to":a.getAttribute("move-to"),"move-by":a.getAttribute("move-by"),"prism-rotation":a.getAttribute("prism-rotation")};la(a,c);window.mlWorld.update();c=new Event("quad-displayed");
a.dispatchEvent(c);b(a._quad)}),Ca=(a)=>new Promise((b,c)=>{if(!a._volume)try{a._volume=P(a)}catch(d){return c(d)}a._volume.visible=!1;Aa(a._volume,a.getAttribute("src")).then((d)=>{a._texture=d;d=new Event("quad-readytoload");a.dispatchEvent(d);a.async?b(a._volume):Ba(a).then(()=>{b(a._volume)}).catch((a)=>{c(Error(`Problem creating quad: ${a}`))})}).catch((a)=>{c(Error(`Problem creating texture: ${a}`))})});class ma extends HTMLElement{attachedCallback(){window.mlWorld?(this.style.display="inline-flex",
this.scrollable?(w(this),y(this)):B(this)?navigator.permissions.request({name:"ml-unbounded-prisms"}).then((a)=>{"granted"==a.state?this.render():"denied"==a.state&&console.error("Permission to render unbounded volume has not been granted")}).catch((a)=>{C(this,"Requesting ml-unbounded-prisms is not supported on this device")}):this.render(),this.extractable&&(v(this),u(this)),E(this),F(this),ia(this)):this.dispatchEvent(new ErrorEvent("error",{error:Error("Unable to render 3D content on this device."),
message:"No mixed-reality browser detected.",bubbles:!0}))}createdCallback(){this.addEventListener("error",function(a){!this._quad&&this.hasAttribute("alt-img")&&this.setAttribute("style","position: absolute;background-image: url("+this.getAttribute("alt-img")+");  background-repeat: no-repeat; background-size:100%;")},!0)}attributeChangedCallback(a,b,c){this._volume&&la(this,{[a]:c})}detachedCallback(){q(this);x(this);ja(this)}get async(){return this.hasAttribute("async")&&(""===this.getAttribute("async")||
"true"===this.getAttribute("async"))}set async(a){this.setAttribute("async",a.toString())}get unbounded(){return this.hasAttribute("unbounded")&&(""===this.getAttribute("unbounded")||"true"===this.getAttribute("unbounded"))}set unbounded(a){this.setAttribute("unbounded",a.toString())}get extractable(){return this.hasAttribute("extractable")&&(""===this.getAttribute("extractable")||"true"===this.getAttribute("extractable"))}set extractable(a){this.setAttribute("extractable",a.toString())}get scrollable(){return this.hasAttribute("scrollable")&&
(""===this.getAttribute("scrollable")||"true"===this.getAttribute("scrollable"))}set scrollable(a){this.setAttribute("scrollable",a.toString())}get scaleScroll(){return this.hasAttribute("scale-scroll")&&(""===this.getAttribute("scale-scroll")||"true"===this.getAttribute("scale-scroll"))}set scaleScroll(a){this.setAttribute("scale-scroll",a.toString())}get breadth(){return parseFloat(this.getAttribute("breadth"))}set breadth(a){isNaN(parseFloat(a))||this.setAttribute("breadth",parseFloat(a))}get color(){return this.getAttribute("color")}set color(a){this.setAttribute("color",
a)}get visibility(){return this.getAttribute("visibility")}set visibility(a){this.setAttribute("visibility",a)}get rotation(){return this.getAttribute("rotation")}set rotation(a){this.setAttribute("rotation",a)}get rotateToAngles(){return this.getAttribute("rotate-to-angles")}set rotateToAngles(a){this.setAttribute("rotate-to-angles",a)}get rotateByAngles(){return this.getAttribute("rotate-by-angles")}set rotateByAngles(a){this.setAttribute("rotate-by-angles",a)}get prismRotation(){return this.getAttribute("prism-rotation")}set prismRotation(a){this.setAttribute("prism-rotation",
a)}get spin(){return this.getAttribute("spin")}set spin(a){this.setAttribute("spin",a)}get quadPosition(){return this.getAttribute("quad-position")}set quadPosition(a){this.setAttribute("quad-position",a)}get quadScale(){return this.getAttribute("quad-scale")}set quadScale(a){this.setAttribute("quad-scale",a)}get raycast(){return this.getAttribute("raycast")}set raycast(a){this.setAttribute("raycast",a.toString())}get scaleTo(){return this.getAttribute("scale-to")}set scaleTo(a){this.setAttribute("scale-to",
a)}get extractedScale(){return parseFloat(this.getAttribute("extracted-scale"))}set extractedScale(a){isNaN(parseFloat(a))||this.setAttribute("extracted-scale",parseFloat(a))}get moveTo(){return this.getAttribute("move-to")}set moveTo(a){this.setAttribute("move-to",a)}get moveBy(){return this.getAttribute("move-by")}set moveBy(a){this.setAttribute("move-by",a)}get src(){return this.getAttribute("src")}set src(a){this.setAttribute("src",a)}get zOffset(){return this.hasAttribute("z-offset")&&!isNaN(parseFloat(this.getAttribute("z-offset")))?
parseFloat(this.getAttribute("z-offset")):150}set zOffset(a){isNaN(parseFloat(a))||this.setAttribute("z-offset",parseFloat(a))}render(){this.src&&this.doRendering().then(()=>{this._volume.visible="hidden"!==this.visibility}).catch((a)=>{this.dispatchEvent(new ErrorEvent("error",{error:a,message:a.message||"Problem rendering node",bubbles:!0}));console.error(`Problem rendering: ${a}`)})}doRendering(){return Ca(this)}createNode(){return createQuad(this)}isInsideVolume(a=this._transform.getLocalPosition(),
b=this._transform.getLocalScale()){let c=Math.fround(this._volume.position.positionX-this._volume.width/2),d=Math.fround(this._volume.position.positionX+this._volume.width/2),e=Math.fround(this._volume.position.positionY-this._volume.height/2),f=Math.fround(this._volume.position.positionY+this._volume.height/2),[g,h]=a,[k,l]=this._quad.getLocalScale(),[m,n]=b;a=Math.fround(this._volume.position.positionX+g-Math.fround(k*m/2));b=Math.fround(this._volume.position.positionX+g+Math.fround(k*m/2));let p=
Math.fround(this._volume.position.positionY+h-Math.fround(l*n/2)),q=Math.fround(this._volume.position.positionY+h+Math.fround(l*n/2));return c<=a&&b<=d&&e<=p&&q<=f}}document.registerElement("ml-quad",ma);let Da=(a)=>{var b=a.split(", ");a=[];for(let c of b)b=c.trim().replace(/  +/g," ").split(" ").map(parseFloat).filter((a)=>!isNaN(a)),4===b.length&&a.push(b);return a};class na extends HTMLElement{createdCallback(){let a=g(this.clientWidth),b=g(this.clientHeight),c=isNaN(this.breadth)?a:g(this.breadth),
d=window.mlWorld.createVolume(a,b,c);this._volume=d;var e=[];for(var f of Da(this.getAttribute("points")))e.push(new DOMPoint(f[0],f[1],f[2],f[3]));f=d.createLine();f.setPoints(e);f.color=this.getAttribute("color")?this.getAttribute("color"):"#FFFFFF";f.name="firstline";e=d.createTransform();e.setLocalScale(new Float32Array([a,b,c]));e.setLocalPosition(new Float32Array([0,0,0]));e.addChild(f);d.addChild(e);n(this)}}document.registerElement("ml-line",na);window.mlWorld?z():console.warn("Unable to render content: No mixed-reality browser detected.");
k.MlModel=ka;k.MlQuad=ma;k.MlLine=na;k.animate=z;Object.defineProperty(k,"__esModule",{value:!0})});
